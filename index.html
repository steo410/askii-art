<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Color ASCII Art Generator</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  height: 100%;
  overflow: hidden;
}

#controls {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #111;
  padding: 10px;
  z-index: 10;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  font-family: system-ui, sans-serif;
}

#asciiCanvas {
  position: absolute;
  left: 0;
  top: var(--control-height);
}
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="imageInput" accept="image/*">

  해상도
  <select id="scale">
    <option value="0.75">높음</option>
    <option value="1" selected>보통</option>
    <option value="2">낮음</option>
  </select>

  문자
  <select id="charset">
    <option value="eng">아스키</option>
    <option value="kor">한글</option>
  </select>

  색상
  <select id="colorMode">
    <option value="original">원본</option>
    <option value="single">단색</option>
  </select>

  <input type="color" id="singleColor" value="#ffffff" disabled>

  <button id="downloadPNG">PNG</button>
  <button id="downloadJPG">JPG</button>
  <button id="downloadTXT">TXT</button>
</div>

<canvas id="asciiCanvas"></canvas>

<script>
const controls = document.getElementById("controls");
const canvas = document.getElementById("asciiCanvas");
const ctx = canvas.getContext("2d");

const imageInput = document.getElementById("imageInput");
const scaleSelect = document.getElementById("scale");
const charsetSelect = document.getElementById("charset");
const colorModeSelect = document.getElementById("colorMode");
const singleColorInput = document.getElementById("singleColor");

const ENG_CHARS =
' .\'`^",:;Il!i<>~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$';

const KOR_CHARS =
'⠀ .·˙ㆍㄱㄴㄷㄹ가나다라마바사아자차카타파하한글힣';

let asciiData = [];
let sourceImage = null;

// 컨트롤 높이 반영
function updateLayout() {
  document.documentElement.style
    .setProperty("--control-height", controls.offsetHeight + "px");
}
window.addEventListener("resize", updateLayout);
updateLayout();

// 옵션 이벤트
colorModeSelect.onchange = () => {
  singleColorInput.disabled = colorModeSelect.value !== "single";
  renderASCII();
};
singleColorInput.oninput = renderASCII;

charsetSelect.onchange = () => {
  if (sourceImage) generateASCII(sourceImage);
};
scaleSelect.onchange = () => {
  if (sourceImage) generateASCII(sourceImage);
};

// 이미지 로드
imageInput.onchange = () => {
  const file = imageInput.files[0];
  if (!file) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    sourceImage = img;
    generateASCII(img);
  };
};

function generateASCII(img) {
  const scale = parseFloat(scaleSelect.value);
  const chars =
    charsetSelect.value === "kor" ? KOR_CHARS : ENG_CHARS;

  const tempCanvas = document.createElement("canvas");
  const tempCtx = tempCanvas.getContext("2d");

  tempCanvas.width = Math.floor(img.width / scale);
  tempCanvas.height = Math.floor(img.height / scale);

  tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
  const data = tempCtx.getImageData(
    0, 0, tempCanvas.width, tempCanvas.height
  ).data;

  asciiData = [];

  for (let y = 0; y < tempCanvas.height; y++) {
    let row = [];
    for (let x = 0; x < tempCanvas.width; x++) {
      const i = (y * tempCanvas.width + x) * 4;
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      const brightness = 0.299*r + 0.587*g + 0.114*b;
      const index = Math.floor(
        brightness / 255 * (chars.length - 1)
      );

      row.push({ ch: chars[index], r, g, b });
    }
    asciiData.push(row);
  }

  renderASCII();
}

function renderASCII() {
  if (!asciiData.length) return;

  const fontSize = 12;
  ctx.font = `${fontSize}px monospace`;

  const charWidth =
    charsetSelect.value === "kor"
      ? ctx.measureText("한").width
      : ctx.measureText("@").width;

  canvas.width = asciiData[0].length * charWidth;
  canvas.height = asciiData.length * fontSize;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.font = `${fontSize}px monospace`;
  ctx.textBaseline = "top";

  const single = colorModeSelect.value === "single";
  const singleColor = singleColorInput.value;

  asciiData.forEach((row, y) => {
    row.forEach((cell, x) => {
      ctx.fillStyle = single
        ? singleColor
        : `rgb(${cell.r},${cell.g},${cell.b})`;

      ctx.fillText(
        cell.ch,
        x * charWidth,
        y * fontSize
      );
    });
  });
}

// 다운로드
function downloadImage(type) {
  const name = prompt("파일 이름을 입력하세요", "ascii_art");
  if (!name) return;

  const url = canvas.toDataURL(
    type === "png" ? "image/png" : "image/jpeg",
    0.95
  );
  const a = document.createElement("a");
  a.href = url;
  a.download = `${name}.${type}`;
  a.click();
}

document.getElementById("downloadPNG").onclick = () => downloadImage("png");
document.getElementById("downloadJPG").onclick = () => downloadImage("jpg");

document.getElementById("downloadTXT").onclick = () => {
  if (!asciiData.length) return;

  const name = prompt("파일 이름을 입력하세요", "ascii_art");
  if (!name) return;

  let txt = "";
  asciiData.forEach(row => {
    row.forEach(c => txt += c.ch);
    txt += "\n";
  });

  const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.txt`;
  a.click();
};
</script>

</body>
</html>
