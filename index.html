<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Color ASCII Art Generator</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: monospace;
  height: 100%;
}

#controls {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #111;
  padding: 10px;
  z-index: 10;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  font-family: system-ui, sans-serif;
}

#ascii {
  position: absolute;
  top: calc(var(--control-height, 80px));
  left: 0;
  right: 0;
  bottom: 0;
  white-space: pre;
  overflow: auto;
}
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="imageInput" accept="image/*">

  해상도
  <select id="scale">
    <option value="0.5">높음</option>
    <option value="1" selected>보통</option>
    <option value="2">낮음</option>
  </select>

  문자
  <select id="charset">
    <option value="eng">아스키</option>
    <option value="kor">한글</option>
  </select>

  색상
  <select id="colorMode">
    <option value="original">원본</option>
    <option value="single">단색</option>
  </select>

  <input type="color" id="singleColor" value="#ffffff" disabled>

  <button id="downloadPNG">PNG</button>
  <button id="downloadJPG">JPG</button>
  <button id="downloadTXT">TXT</button>
</div>

<div id="ascii"></div>

<script>
const controls = document.getElementById("controls");
const asciiDiv = document.getElementById("ascii");

const imageInput = document.getElementById("imageInput");
const scaleSelect = document.getElementById("scale");
const charsetSelect = document.getElementById("charset");
const colorModeSelect = document.getElementById("colorMode");
const singleColorInput = document.getElementById("singleColor");

const ENG_CHARS = ' .\'`^",:;Il!i<>~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$';
const KOR_CHARS = ' 가나다라마바사아자차카타파하';


let asciiData = [];

// 컨트롤 높이 반영
function updateLayout() {
  const h = controls.offsetHeight;
  document.documentElement.style.setProperty("--control-height", h + "px");
}
window.addEventListener("resize", updateLayout);
updateLayout();

colorModeSelect.addEventListener("change", () => {
  singleColorInput.disabled = colorModeSelect.value !== "single";
  renderASCII();
});

singleColorInput.addEventListener("input", renderASCII);
scaleSelect.addEventListener("change", renderASCII);
charsetSelect.addEventListener("change", renderASCII);

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (!file) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => generateASCII(img);
});

function generateASCII(img) {
  const scale = parseFloat(scaleSelect.value);
  const chars = charsetSelect.value === "kor" ? KOR_CHARS : ENG_CHARS;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = Math.floor(img.width / scale);
  canvas.height = Math.floor(img.height / scale);

  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

  asciiData = [];

  for (let y = 0; y < canvas.height; y++) {
    let row = [];
    for (let x = 0; x < canvas.width; x++) {
      const i = (y * canvas.width + x) * 4;
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      const brightness = 0.299*r + 0.587*g + 0.114*b;
      const index = Math.floor(
        (brightness / 255) * (chars.length - 1)
      );

      row.push({
        ch: chars[index],
        r, g, b
      });
    }
    asciiData.push(row);
  }

  renderASCII();
}

function renderASCII() {
  if (!asciiData.length) return;

  const colorMode = colorModeSelect.value;
  const singleColor = singleColorInput.value;

  let html = "";

  asciiData.forEach(row => {
    row.forEach(cell => {
      let color = `rgb(${cell.r},${cell.g},${cell.b})`;
      if (colorMode === "single") color = singleColor;
      html += `<span style="color:${color}">${cell.ch}</span>`;
    });
    html += "\n";
  });

  asciiDiv.innerHTML = html;
}

function downloadImage(type) {
  const fontSize = 12;
  const charWidth = fontSize * 0.6;

  const out = document.createElement("canvas");
  const ctx = out.getContext("2d");

  out.width = asciiData[0].length * charWidth;
  out.height = asciiData.length * fontSize;

  if (type === "jpg") {
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, out.width, out.height);
  }

  ctx.font = `${fontSize}px monospace`;
  ctx.textBaseline = "top";

  asciiData.forEach((row, y) => {
    row.forEach((cell, x) => {
      const color =
        colorModeSelect.value === "single"
          ? singleColorInput.value
          : `rgb(${cell.r},${cell.g},${cell.b})`;

      ctx.fillStyle = color;
      ctx.fillText(cell.ch, x * charWidth, y * fontSize);
    });
  });

  const url = out.toDataURL(
    type === "png" ? "image/png" : "image/jpeg",
    0.95
  );

  const a = document.createElement("a");
  a.href = url;
  a.download = `ascii.${type}`;
  a.click();
}

document.getElementById("downloadPNG").onclick = () => downloadImage("png");
document.getElementById("downloadJPG").onclick = () => downloadImage("jpg");

document.getElementById("downloadTXT").onclick = () => {
  let txt = "";
  asciiData.forEach(row => {
    row.forEach(c => txt += c.ch);
    txt += "\n";
  });

  const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ascii.txt";
  a.click();
};
</script>

</body>
</html>
