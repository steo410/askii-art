<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Color ASCII Art Generator</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  height: 100%;
}

#controls {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #111;
  padding: 10px;
  z-index: 10;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  font-family: system-ui, sans-serif;
}

#asciiCanvas {
  position: absolute;
  top: calc(var(--control-height, 80px));
  left: 0;
}
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="imageInput" accept="image/*">

  í•´ìƒë„
  <select id="scale">
    <option value="0.75">ë†’ìŒ</option>
    <option value="1" selected>ë³´í†µ</option>
    <option value="2">ë‚®ìŒ</option>
  </select>

  ë¬¸ì
  <select id="charset">
    <option value="eng">ì•„ìŠ¤í‚¤</option>
    <option value="kor">í•œê¸€</option>
  </select>

  ìƒ‰ìƒ
  <select id="colorMode">
    <option value="original">ì›ë³¸</option>
    <option value="single">ë‹¨ìƒ‰</option>
  </select>

  <input type="color" id="singleColor" value="#ffffff" disabled>

  <button id="downloadPNG">PNG</button>
  <button id="downloadJPG">JPG</button>
  <button id="downloadTXT">TXT</button>
</div>

<canvas id="asciiCanvas"></canvas>

<script>
const controls = document.getElementById("controls");
const canvasOut = document.getElementById("asciiCanvas");
const ctxOut = canvasOut.getContext("2d");

const imageInput = document.getElementById("imageInput");
const scaleSelect = document.getElementById("scale");
const charsetSelect = document.getElementById("charset");
const colorModeSelect = document.getElementById("colorMode");
const singleColorInput = document.getElementById("singleColor");

const ENG_CHARS =
' .\'`^",:;Il!i<>~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$';

const KOR_CHARS =
'â € .Â·Ë™ã†ã„±ã„´ã„·ã„¹ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜í•œê¸€í£';

let asciiData = [];
let sourceImage = null;

// ì»¨íŠ¸ë¡¤ ë†’ì´ ë°˜ì˜
function updateLayout() {
  document.documentElement.style
    .setProperty("--control-height", controls.offsetHeight + "px");
}
window.addEventListener("resize", updateLayout);
updateLayout();

// ì˜µì…˜ ì´ë²¤íŠ¸
colorModeSelect.onchange = () => {
  singleColorInput.disabled = colorModeSelect.value !== "single";
  renderASCII();
};
singleColorInput.oninput = renderASCII;

// charset / í•´ìƒë„ ë³€ê²½ â†’ ì¬ìƒì„±
charsetSelect.onchange = () => {
  if (sourceImage) generateASCII(sourceImage);
};
scaleSelect.onchange = () => {
  if (sourceImage) generateASCII(sourceImage);
};

// ì´ë¯¸ì§€ ë¡œë“œ
imageInput.onchange = () => {
  const file = imageInput.files[0];
  if (!file) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    sourceImage = img;
    generateASCII(img);
  };
};

function generateASCII(img) {
  const scale = parseFloat(scaleSelect.value);
  const chars =
    charsetSelect.value === "kor" ? KOR_CHARS : ENG_CHARS;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = Math.floor(img.width / scale);
  canvas.height = Math.floor(img.height / scale);

  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

  asciiData = [];
  const inv255 = 1 / 255;

  for (let y = 0; y < canvas.height; y++) {
    let row = [];
    for (let x = 0; x < canvas.width; x++) {
      const i = (y * canvas.width + x) * 4;
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      const brightness = 0.299*r + 0.587*g + 0.114*b;
      const index = Math.floor(brightness * inv255 * (chars.length - 1));

      row.push({ ch: chars[index], r, g, b });
    }
    asciiData.push(row);
  }

  renderASCII();
}

function renderASCII() {
  if (!asciiData.length) return;

  const fontSize = 12;

  // ğŸ”‘ í•œê¸€/ASCII ì‹¤ì œ í­ ì¸¡ì • (ê²¹ì¹¨ ë°©ì§€)
  ctxOut.font = `${fontSize}px monospace`;
  const charWidth =
    charsetSelect.value === "kor"
      ? ctxOut.measureText("í•œ").width
      : ctxOut.measureText("@").width;

  canvasOut.width = asciiData[0].length * charWidth;
  canvasOut.height = asciiData.length * fontSize;

  ctxOut.clearRect(0, 0, canvasOut.width, canvasOut.height);
  ctxOut.font = `${fontSize}px monospace`;
  ctxOut.textBaseline = "top";

  const single = colorModeSelect.value === "single";
  const singleColor = singleColorInput.value;

  asciiData.forEach((row, y) => {
    row.forEach((cell, x) => {
      ctxOut.fillStyle = single
        ? singleColor
        : `rgb(${cell.r},${cell.g},${cell.b})`;

      ctxOut.fillText(
        cell.ch,
        x * charWidth,
        y * fontSize
      );
    });
  });
}

// ë‹¤ìš´ë¡œë“œ
function downloadImage(type) {
  const url = canvasOut.toDataURL(
    type === "png" ? "image/png" : "image/jpeg",
    0.95
  );
  const a = document.createElement("a");
  a.href = url;
  a.download = `ascii.${type}`;
  a.click();
}

document.getElementById("downloadPNG").onclick = () => downloadImage("png");
document.getElementById("downloadJPG").onclick = () => downloadImage("jpg");

document.getElementById("downloadTXT").onclick = () => {
  let txt = "";
  asciiData.forEach(row => {
    row.forEach(c => txt += c.ch);
    txt += "\n";
  });
  const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ascii.txt";
  a.click();
};
</script>

</body>
</html>
