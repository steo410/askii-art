<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ASCII Art Generator</title>

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: monospace;
      padding: 20px;
    }

    h2 {
      margin-bottom: 10px;
    }

    label {
      margin-right: 15px;
    }

    #ascii {
      margin-top: 20px;
      white-space: pre;
      font-size: 8px;
      line-height: 8px;
    }

    canvas {
      display: none;
    }
  </style>
</head>
<body>

<h2>이미지 → ASCII 아트</h2>

<input type="file" accept="image/*" id="upload" />

<br><br>

<label>
  글자 색상:
  <input type="color" id="color" value="#ffffff">
</label>

<label>
  해상도 배율:
  <select id="scale">
    <option value="1">1x</option>
    <option value="2">2x</option>
    <option value="4">4x</option>
  </select>
</label>

<label>
  다운로드 형식:
  <select id="format">
    <option value="png">PNG</option>
    <option value="jpg">JPG</option>
  </select>
</label>

<button id="download">이미지 다운로드</button>

<div id="ascii"></div>

<canvas id="canvas"></canvas>

<script>
const upload = document.getElementById("upload");
const asciiDiv = document.getElementById("ascii");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const colorInput = document.getElementById("color");
const scaleSelect = document.getElementById("scale");
const formatSelect = document.getElementById("format");
const downloadBtn = document.getElementById("download");

// 밝기 → 문자
const chars =
"$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvunxrjft|()1{}[]?-_+~<>i!lI;:,\"^`'. ";

let asciiText = "";

// 이미지 → ASCII
upload.addEventListener("change", () => {
  const file = upload.files[0];
  if (!file) return;

  const img = new Image();
  img.onload = () => {
    const baseScale = 0.5;
    canvas.width = img.width * baseScale;
    canvas.height = img.height * baseScale;

    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

    let result = "";

    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const i = (y * canvas.width + x) * 4;
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
        const index = Math.floor(
          (brightness / 255) * (chars.length - 1)
        );

        result += chars[index];
      }
      result += "\n";
    }

    asciiText = result;
    asciiDiv.textContent = asciiText;
    asciiDiv.style.color = colorInput.value;
  };

  img.src = URL.createObjectURL(file);
});

// 색상 변경
colorInput.addEventListener("input", () => {
  asciiDiv.style.color = colorInput.value;
});

// 다운로드
downloadBtn.addEventListener("click", () => {
  if (!asciiText.trim()) return;

  const lines = asciiText.split("\n");
  const scale = parseInt(scaleSelect.value);
  const fontSize = 8 * scale;
  const font = `${fontSize}px monospace`;

  const outCanvas = document.createElement("canvas");
  const outCtx = outCanvas.getContext("2d");

  outCtx.font = font;

  const width = Math.max(
    ...lines.map(line => outCtx.measureText(line).width)
  );

  outCanvas.width = Math.ceil(width);
  outCanvas.height = lines.length * fontSize;

  // JPG 배경
  if (formatSelect.value === "jpg") {
    outCtx.fillStyle = "#ffffff";
    outCtx.fillRect(0, 0, outCanvas.width, outCanvas.height);
  }

  outCtx.font = font;
  outCtx.fillStyle = colorInput.value;
  outCtx.textBaseline = "top";

  lines.forEach((line, i) => {
    outCtx.fillText(line, 0, i * fontSize);
  });

  const mime =
    formatSelect.value === "png"
      ? "image/png"
      : "image/jpeg";

  const url = outCanvas.toDataURL(mime, 1.0);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ascii-art.${formatSelect.value}`;
  a.click();
});
</script>

</body>
</html>
